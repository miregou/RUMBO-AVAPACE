<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rumbo - Nuestra Huella de Evolución</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Librería para exportación a PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            scroll-behavior: smooth;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        
        .animate-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        #pdf-template { font-family: 'Plus Jakarta Sans', sans-serif; color: #1e293b; }
        
        .nav-btn.active {
            background-color: #f43f5e;
            color: white;
            box-shadow: 0 10px 15px -3px rgba(244, 63, 94, 0.2);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <div id="app" class="flex min-h-screen overflow-hidden">
        <!-- Barra Lateral -->
        <aside class="w-72 bg-white border-r border-slate-200 hidden md:flex flex-col sticky top-0 h-screen shadow-sm z-20">
            <div class="p-8 border-b border-slate-100">
                <div class="flex items-center gap-3 text-rose-500 mb-1">
                    <svg viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8">
                        <path d="M13,4.5c1.1,0,2-0.9,2-2s-0.9-2-2-2s-2,0.9-2,2S11.9,4.5,13,4.5z M8.5,8c1.1,0,2-0.9,2-2s-0.9-2-2-2s-2,0.9-2,2S7.4,8,8.5,8z M16.5,8.5c0.8,0,1.5-0.7,1.5-1.5S17.3,5.5,16.5,5.5S15,6.2,15,7S15.7,8.5,16.5,8.5z M6.5,11.5c0.6,0,1-0.4,1-1s-0.4-1-1-1s-1,0.4-1,1S5.9,11.5,6.5,11.5z M18.5,12c0.6,0,1-0.4,1-1s-0.4-1-1-1s-1,0.4-1,1S17.9,12,18.5,12z M12,10.5c-2.8,0-5,2.2-5,5c0,2.8,2.2,5,5,5s5-2.2,5-5C17,12.7,14.8,10.5,12,10.5z"/>
                    </svg>
                    <h1 class="text-2xl font-black tracking-tighter uppercase text-slate-800">Rumbo</h1>
                </div>
                <p class="text-[10px] text-slate-400 uppercase tracking-widest font-extrabold">Huella de Evolución</p>
            </div>
            
            <nav class="flex-1 p-6 space-y-2 overflow-y-auto custom-scrollbar">
                <button onclick="switchTab('dashboard')" id="btn-dashboard" class="nav-btn w-full flex items-center gap-3 px-5 py-3.5 rounded-2xl transition-all font-bold text-slate-500 hover:bg-slate-50">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Vista General
                </button>
                <button onclick="switchTab('charts')" id="btn-charts" class="nav-btn w-full flex items-center gap-3 px-5 py-3.5 rounded-2xl transition-all font-bold text-slate-500 hover:bg-slate-50">
                    <i data-lucide="trending-up" class="w-5 h-5"></i> Análisis de Rumbo
                </button>
                
                <div class="pt-8 pb-3 px-5 flex items-center justify-between">
                    <span class="text-[10px] font-black text-slate-300 uppercase tracking-widest">Áreas de Trabajo</span>
                    <button onclick="showModal('modal-block')" class="text-rose-500 hover:bg-rose-50 p-1 rounded-lg transition-colors">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                    </button>
                </div>
                
                <div id="blocks-list" class="space-y-1"></div>
            </nav>
            
            <div class="p-6 bg-slate-50/50 space-y-2 border-t border-slate-100">
                <button onclick="showModal('modal-kpi')" class="w-full bg-rose-500 text-white py-3.5 rounded-2xl font-bold hover:bg-rose-600 shadow-xl shadow-rose-100 flex items-center justify-center gap-2 active:scale-95 transition-all text-sm">
                    <i data-lucide="file-plus" class="w-5 h-5"></i> Añadir Objetivo
                </button>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="exportToPDF()" class="w-full bg-white border border-slate-200 text-slate-600 py-2.5 rounded-xl font-bold hover:bg-slate-50 flex items-center justify-center gap-2 text-[10px] uppercase">
                        <i data-lucide="download-cloud" class="w-3 h-3 text-rose-500"></i> PDF
                    </button>
                    <button onclick="exportStandaloneHTML()" class="w-full bg-slate-800 text-slate-200 py-2.5 rounded-xl font-bold hover:bg-slate-900 flex items-center justify-center gap-2 text-[10px] uppercase tracking-tighter">
                        <i data-lucide="share-2" class="w-3 h-3"></i> Versión Datos
                    </button>
                </div>
            </div>
        </aside>

        <!-- Contenido Principal -->
        <main class="flex-1 p-6 md:p-10 overflow-y-auto bg-slate-50 relative">
            <header class="mb-12">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
                    <div>
                        <h2 id="view-title" class="text-4xl font-black text-slate-800 tracking-tight italic">Cargando...</h2>
                        <p id="view-desc" class="text-slate-500 mt-2 text-lg font-medium"></p>
                    </div>
                    <div id="sync-indicator" class="bg-amber-50 text-amber-600 px-5 py-2 rounded-full text-[10px] font-black flex items-center gap-2 border border-amber-100 uppercase tracking-widest shadow-sm">
                        <span class="w-2 h-2 bg-amber-500 rounded-full animate-pulse"></span> Proyecto Standalone
                    </div>
                </div>
            </header>

            <div id="view-dashboard" class="tab-content grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 hidden animate-in"></div>
            <div id="view-charts" class="tab-content space-y-12 hidden animate-in"></div>
            <div id="view-bloque" class="tab-content space-y-8 hidden animate-in"></div>
        </main>
    </div>

    <!-- Plantilla PDF -->
    <div id="pdf-report-container" class="hidden">
        <div id="pdf-template" class="p-12 bg-white">
            <div class="flex justify-between items-center border-b-4 border-rose-500 pb-10 mb-10">
                <div>
                    <h1 class="text-3xl font-black text-slate-800 uppercase tracking-tighter">Informe de Rumbo</h1>
                    <p class="text-rose-500 font-bold tracking-[0.2em] uppercase text-xs mt-1">Consolidado de Evolución de Metas</p>
                </div>
                <div class="text-right">
                    <p id="pdf-date" class="text-sm font-black text-slate-700"></p>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">Reporte de Gestión</p>
                </div>
            </div>
            <div id="pdf-content"></div>
        </div>
    </div>

    <!-- Modales -->
    <div id="modal-kpi" class="fixed inset-0 bg-slate-900/60 backdrop-blur-xl z-50 hidden flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-2xl rounded-[48px] shadow-2xl overflow-hidden animate-in">
            <div class="bg-rose-500 p-10 text-white flex justify-between items-center">
                <div><h3 class="text-3xl font-black">Nuevo Objetivo</h3><p class="text-rose-100 text-sm mt-2 font-bold uppercase tracking-widest uppercase">Parámetros de Medición</p></div>
                <button onclick="hideModal('modal-kpi')" class="hover:bg-white/10 p-3 rounded-full transition-colors"><i data-lucide="x-circle"></i></button>
            </div>
            <form id="form-kpi" class="p-10 space-y-6">
                <input required id="kpi-nombre" type="text" placeholder="Código (ej. AP15)" class="w-full p-5 bg-slate-50 border border-slate-200 rounded-[24px] outline-none font-bold text-lg">
                <textarea required id="kpi-definicion" placeholder="¿Qué vamos a valorar específicamente?" class="w-full p-5 bg-slate-50 border border-slate-200 rounded-[24px] h-24 outline-none font-medium"></textarea>
                <div class="grid grid-cols-2 gap-6 bg-slate-50 p-8 rounded-[32px] border border-slate-100 shadow-inner">
                    <div class="space-y-1 text-center">
                        <label class="text-[10px] font-black text-rose-600 uppercase tracking-widest">Meta Objetivo (%)</label>
                        <input required id="kpi-meta" type="number" placeholder="Ej: 80" class="w-full p-4 bg-white border border-slate-200 rounded-2xl font-black text-center text-xl">
                    </div>
                    <div class="space-y-1 text-center">
                        <label class="text-[10px] font-black text-rose-600 uppercase tracking-widest">Total Periodo</label>
                        <input required id="kpi-total" type="number" placeholder="Ej: 100" class="w-full p-4 bg-white border border-slate-200 rounded-2xl font-black text-center text-xl">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <select id="kpi-bloque" class="p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold text-sm outline-none"></select>
                    <div class="flex items-center gap-2 p-4 bg-orange-50 rounded-2xl border border-orange-100">
                        <input id="kpi-inverso" type="checkbox" class="w-6 h-6 accent-orange-500 rounded-lg">
                        <span class="text-[10px] font-black text-orange-800 uppercase leading-none">Meta Máxima</span>
                    </div>
                </div>
                <button type="submit" class="w-full py-5 bg-rose-500 text-white font-black rounded-[24px] shadow-xl hover:bg-rose-600 uppercase tracking-widest transition-all">Registrar en Rumbo</button>
            </form>
        </div>
    </div>

    <div id="modal-block" class="fixed inset-0 bg-slate-900/40 backdrop-blur-xl z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-[32px] p-12 shadow-2xl animate-in border border-slate-100">
            <h3 class="text-2xl font-black text-slate-800 text-center mb-8 uppercase tracking-tighter">Nueva Área de Gestión</h3>
            <form id="form-block" class="space-y-6">
                <input required id="block-name" type="text" placeholder="Ej. Área Técnica" class="w-full p-5 bg-slate-50 border border-slate-200 rounded-[20px] outline-none font-bold text-center text-lg">
                <button type="submit" class="w-full py-4 bg-rose-500 text-white font-black rounded-[20px] uppercase tracking-widest shadow-lg">Crear</button>
            </form>
        </div>
    </div>

    <script id="app-state-script">
        // --- ESTADO INICIAL DEL PROYECTO (MD82REGE) ---
        let state = {
            activeTab: 'dashboard',
            activeBloque: '',
            blocks: [
                { id: '1', name: 'Gerencia' },
                { id: '2', name: 'Laboral' },
                { id: '3', name: 'Centros' }
            ],
            indicators: [
                { id: 'ap1', nombre: "AP1 - Revisión documentación", metaNum: 33, unidad: "%", totalPeriodo: 100, valorActual: 0, definicion: "% de documentos revisados del sistema", bloque: "Gerencia", historial: [], inverso: false },
                { id: 'ap2', nombre: "AP2 - Gestión de los objetivos", metaNum: 100, unidad: "%", totalPeriodo: 100, valorActual: 0, definicion: "% de cumplimiento de los objetivos de la calidad", bloque: "Gerencia", historial: [], inverso: false },
                { id: 'ap3', nombre: "AP3 - Eficacia del plan de gestión", metaNum: 20, unidad: "%", totalPeriodo: 100, valorActual: 0, definicion: "% de acciones ineficaces contenidas en el plan", bloque: "Gerencia", historial: [], inverso: true },
                { id: 'ap4', nombre: "AP4 - Planificación plan de gestión", metaNum: 30, unidad: "%", totalPeriodo: 100, valorActual: 0, definicion: "% de acciones no finalizadas (retrasadas)", bloque: "Gerencia", historial: [], inverso: true },
                { id: 'ap5', nombre: "AP5 - Cumplimiento plan formación", metaNum: 80, unidad: "%", totalPeriodo: 100, valorActual: 0, definicion: "% de cumplimiento del plan de formación", bloque: "Gerencia", historial: [], inverso: false },
                { id: 'ap6', nombre: "AP6 - Satisfacción formación", metaNum: 7, unidad: "ptos", totalPeriodo: 10, valorActual: 0, definicion: "Media de satisfacción con la formación recibida", bloque: "Gerencia", historial: [], inverso: false },
                { id: 'ap7', nombre: "AP7 - Satisfacción usuarios", metaNum: 80, unidad: "%", totalPeriodo: 100, valorActual: 0, definicion: "% de encuestas realizadas sobre el total", bloque: "Gerencia", historial: [], inverso: false },
                { id: 'ap8', nombre: "AP8 - Supervisión compras", metaNum: 100, unidad: "%", totalPeriodo: 100, valorActual: 0, definicion: "% de pedidos sin partida firmados por gerencia", bloque: "Gerencia", historial: [], inverso: false },
                { id: 'ap12', nombre: "AP12 - Celeridad reclamaciones", metaNum: 30, unidad: "días", totalPeriodo: 30, valorActual: 0, definicion: "Meta <= 30 días naturales", bloque: "Gerencia", historial: [], inverso: true },
                { id: 'ap13', nombre: "AP13 - Eficacia AC", metaNum: 90, unidad: "%", totalPeriodo: 100, valorActual: 0, definicion: "% de Acciones correctivas eficaces", bloque: "Gerencia", historial: [], inverso: false },
                { id: 'ap14', nombre: "AP14 - Eficacia gestión NC", metaNum: 90, unidad: "%", totalPeriodo: 100, valorActual: 0, definicion: "% de N.C. analizadas en < 1 mes", bloque: "Gerencia", historial: [], inverso: false },
            ]
        };
    </script>

    <script>
        function init() { 
            lucide.createIcons(); 
            switchTab(state.activeTab, state.activeBloque); 
            renderBlocks(); 
        }

        window.switchTab = (tab, bloque = '') => {
            state.activeTab = tab; state.activeBloque = bloque;
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active', 'bg-rose-500', 'text-white', 'shadow-lg'));
            const titles = { dashboard: ['Nuestra Evolución', 'Huella acumulada de éxito consolidado por área estratégica.'], charts: ['Análisis de Rumbo', 'Tendencias visuales de rendimiento vs criterios técnicos.'], bloque: [bloque, `Seguimiento detallado para el área de ${bloque}.`] };
            const viewTitle = document.getElementById('view-title'); const viewDesc = document.getElementById('view-desc'); const targetView = document.getElementById(`view-${tab}`);
            if(viewTitle) viewTitle.innerText = titles[tab][0]; if(viewDesc) viewDesc.innerText = titles[tab][1];
            if(targetView) targetView.classList.remove('hidden');
            if (tab !== 'bloque') { const btn = document.getElementById(`btn-${tab}`); if(btn) btn.classList.add('active'); }
            renderBlocks(); renderAll();
        };

        function renderBlocks() {
            const list = document.getElementById('blocks-list'); const select = document.getElementById('kpi-bloque');
            if(!list || !select) return; list.innerHTML = ''; select.innerHTML = '';
            state.blocks.forEach(b => {
                const active = state.activeTab === 'bloque' && state.activeBloque === b.name;
                list.innerHTML += `<button onclick="switchTab('bloque', '${b.name}')" class="w-full flex items-center justify-between px-5 py-3 rounded-2xl transition-all ${active ? 'bg-rose-50 text-rose-600 font-bold shadow-sm' : 'text-slate-500 hover:bg-slate-50'}"><span class="flex items-center gap-3 truncate text-sm font-semibold"><i data-lucide="folder" class="w-4 h-4"></i> ${b.name}</span></button>`;
                select.innerHTML += `<option value="${b.name}">${b.name}</option>`;
            });
            lucide.createIcons();
        }

        function renderAll() {
            if (state.activeTab === 'dashboard') renderDashboard();
            if (state.activeTab === 'charts') renderCharts();
            if (state.activeTab === 'bloque') renderBloqueDetail();
        }

        function renderDashboard() {
            const view = document.getElementById('view-dashboard'); if(!view) return; view.innerHTML = '';
            state.blocks.forEach(b => {
                const inds = state.indicators.filter(i => i.bloque === b.name);
                const achieved = inds.filter(i => { const perc = Math.round((i.valorActual / (i.totalPeriodo || 1)) * 100); return i.inverso ? perc <= i.metaNum : perc >= i.metaNum; }).length;
                const progress = inds.length ? Math.round((achieved / inds.length) * 100) : 0;
                view.innerHTML += `<div class="bg-white p-8 rounded-[40px] border border-slate-200 shadow-sm hover:shadow-2xl transition-all duration-500 group"><div class="flex justify-between items-start mb-8"><div class="bg-rose-50 p-4 rounded-[20px] text-rose-500 shadow-sm"><i data-lucide="footprints"></i></div><div class="text-right"><span class="text-[10px] font-black text-slate-300 uppercase block tracking-widest">Éxito Total</span><span class="text-3xl font-black text-slate-800">${progress}%</span></div></div><h3 class="font-black text-slate-800 text-2xl mb-8">${b.name}</h3><div class="space-y-4"><div class="flex justify-between text-[11px] font-black text-slate-400 uppercase tracking-widest"><span>Logrados</span><span>${achieved}/${inds.length}</span></div><div class="w-full bg-slate-100 h-4 rounded-full overflow-hidden shadow-inner"><div class="bg-rose-500 h-full transition-all duration-1000 ease-out" style="width: ${progress}%"></div></div></div><button onclick="switchTab('bloque', '${b.name}')" class="mt-10 w-full py-4 bg-slate-50 text-slate-600 text-[11px] font-black rounded-[20px] hover:bg-rose-500 hover:text-white uppercase tracking-widest shadow-sm">Detalle Área</button></div>`;
            });
            lucide.createIcons();
        }

        function renderCharts() {
            const view = document.getElementById('view-charts'); if(!view) return; view.innerHTML = '';
            state.blocks.forEach(b => {
                const inds = state.indicators.filter(i => i.bloque === b.name).sort((x, y) => { 
                    const matchA = x.nombre.match(/AP(\d+)/); const matchB = y.nombre.match(/AP(\d+)/);
                    return (matchA && matchB) ? parseInt(matchA[1]) - parseInt(matchB[1]) : 0; 
                });
                if (inds.length === 0) return;
                const chartWidth = 800; const chartHeight = 350; const padding = 50; const barWidth = (chartWidth - padding * 2) / (inds.length || 1);
                const getY = (val) => chartHeight - padding - ((val / 100) * (chartHeight - padding * 2));
                let bars = '';
                inds.forEach((ind, i) => {
                    const perc = Math.round((ind.valorActual / (ind.totalPeriodo || 1)) * 100); 
                    const success = ind.inverso ? perc <= ind.metaNum : perc >= ind.metaNum;
                    const x = padding + i * barWidth + barWidth / 2;
                    bars += `<g class="group"><rect x="${x - barWidth/4}" y="${getY(perc)}" width="${barWidth/2}" height="${(perc/100)*(chartHeight-padding*2)}" fill="${success?'#f43f5e':'#cbd5e1'}" rx="4" /><line x1="${x - barWidth/3}" y1="${getY(ind.metaNum)}" x2="${x + barWidth/3}" y2="${getY(ind.metaNum)}" stroke="#1e293b" stroke-width="2" stroke-dasharray="4 2" /><text x="${x}" y="${chartHeight - padding + 20}" text-anchor="middle" class="text-[9px] fill-slate-400 font-bold uppercase">${ind.nombre.split(' ')[0]}</text><text x="${x}" y="${chartHeight - padding + 35}" text-anchor="middle" class="text-[10px] fill-rose-600 font-black">${perc}%</text></g>`;
                });
                view.innerHTML += `<div class="bg-white p-10 rounded-[48px] border border-slate-200 shadow-xl overflow-hidden mb-12"><div class="flex justify-between items-center mb-10"><div><h3 class="text-2xl font-black text-slate-800 italic uppercase tracking-tighter">${b.name}</h3><p class="text-xs font-bold text-slate-400 uppercase tracking-widest mt-1">Comparativa vs Criterio</p></div><div class="flex gap-4"><span class="flex items-center gap-2 text-[10px] font-black uppercase text-slate-400"><i class="w-3 h-3 bg-rose-500 rounded-sm inline-block"></i> Logro</span><span class="flex items-center gap-2 text-[10px] font-black uppercase text-slate-400"><i class="w-3 h-0.5 bg-slate-800 border-t border-dashed border-slate-800 inline-block"></i> Objetivo</span></div></div><svg viewBox="0 0 ${chartWidth} ${chartHeight}" class="w-full h-auto overflow-visible">${[0, 50, 100].map(v => `<line x1="${padding}" y1="${getY(v)}" x2="${chartWidth-padding}" y2="${getY(v)}" stroke="#f1f5f9" stroke-width="2"/><text x="${padding-15}" y="${getY(v)+4}" text-anchor="end" class="text-[10px] fill-slate-300 font-black">${v}%</text>`).join('')}${bars}</svg></div>`;
            });
        }

        function renderBloqueDetail() {
            const view = document.getElementById('view-bloque'); if(!view) return; view.innerHTML = '';
            const inds = state.indicators.filter(i => i.bloque === state.activeBloque).sort((x, y) => {
                const matchA = x.nombre.match(/AP(\d+)/); const matchB = y.nombre.match(/AP(\d+)/);
                return (matchA && matchB) ? parseInt(matchA[1]) - parseInt(matchB[1]) : 0;
            });
            inds.forEach(ind => {
                const perc = Math.round((ind.valorActual / (ind.totalPeriodo || 1)) * 100); const ok = ind.inverso ? perc <= ind.metaNum : perc >= ind.metaNum;
                const history = [...ind.historial].reverse().map(h => `<div class="bg-white p-3 rounded-2xl border border-slate-100 flex justify-between items-center mb-2 shadow-sm"><span class="font-black text-rose-500 text-sm">${Math.round((h.valor/ind.totalPeriodo)*100)}%</span><span class="text-[10px] text-slate-300 font-black uppercase tracking-tighter">${h.fecha}</span></div>`).join('');
                view.innerHTML += `<div class="bg-white rounded-[40px] border border-slate-200 shadow-sm p-8 grid grid-cols-1 lg:grid-cols-12 gap-10 items-center hover:border-rose-200 transition-colors"><div class="lg:col-span-4"><span class="text-[9px] font-black px-3 py-1 rounded-full uppercase border ${ok?'bg-green-50 text-green-600 border-green-100':'bg-rose-50 text-rose-600 border-rose-100'} mb-4 inline-block">${ok?'Logrado':'En Marcha'}</span><h4 class="text-xl font-black text-slate-800 tracking-tight">${ind.nombre}</h4><p class="text-xs text-slate-400 mt-4 leading-relaxed font-medium"><i data-lucide="info" class="w-4 h-4 text-rose-400 shrink-0 inline mr-2"></i>${ind.definicion}</p><div class="mt-8 pt-6 border-t border-slate-100 flex items-center gap-4"><div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Ciclo Total:</div><input type="number" onchange="updateDenominator('${ind.id}', this.value)" value="${ind.totalPeriodo}" class="w-20 p-2 bg-slate-50 border border-slate-200 rounded-xl text-center font-black"></div></div><div class="lg:col-span-3 bg-slate-50 p-10 rounded-[48px] border border-slate-100 shadow-inner text-center"><div class="text-5xl font-black text-rose-500 mb-4 tracking-tighter">${perc}%</div><div class="text-[10px] font-bold text-slate-400 mb-8 uppercase tracking-widest">Criterio: ${ind.inverso?'≤':'≥'} ${ind.metaNum}${ind.unidad}</div><div class="flex gap-2"><input id="inp-${ind.id}" type="number" placeholder="Dato..." class="w-full p-4 bg-white border border-slate-200 rounded-2xl font-black text-center text-lg focus:ring-4 focus:ring-rose-50 transition-all outline-none"><button onclick="addProgress('${ind.id}')" class="bg-rose-500 text-white p-4 rounded-2xl shadow-lg active:scale-90"><i data-lucide="check" class="w-6 h-6"></i></button></div></div><div class="lg:col-span-5 border-l border-slate-100 pl-10 h-full max-h-[250px] overflow-y-auto custom-scrollbar"><div class="text-[10px] font-black text-slate-300 uppercase tracking-widest mb-4 flex items-center gap-2"><i data-lucide="history" class="w-4 h-4"></i> Serie Histórica</div>${history || '<p class="text-xs text-slate-300 italic py-10 text-center uppercase tracking-widest font-bold">Sin registros.</p>'}</div></div>`;
            });
            lucide.createIcons();
        }

        // --- EXPORTAR ---
        window.exportStandaloneHTML = () => {
            const currentState = JSON.stringify(state, null, 4); const currentHTML = document.documentElement.outerHTML;
            const updatedHTML = currentHTML.replace(/<script id="app-state-script">[\s\S]*?<\/script>/, `<script id="app-state-script">\n        let state = ${currentState};\n    <\/script>`);
            const blob = new Blob([updatedHTML], { type: 'text/html' }); const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `Rumbo_Proyecto_con_Datos.html`; a.click();
        };

        window.exportToPDF = () => {
            const content = document.getElementById('pdf-content'); document.getElementById('pdf-date').innerText = new Date().toLocaleDateString();
            content.innerHTML = '';
            state.blocks.forEach(b => {
                const inds = state.indicators.filter(i => i.bloque === b.name);
                const achieved = inds.filter(i => { const perc = Math.round((i.valorActual / (i.totalPeriodo || 1)) * 100); return i.inverso ? perc <= i.metaNum : perc >= i.metaNum; }).length;
                const progress = inds.length ? Math.round((achieved / inds.length) * 100) : 0;
                let tableRows = inds.map(ind => { const perc = Math.round((ind.valorActual / (ind.totalPeriodo || 1)) * 100); const success = ind.inverso ? perc <= ind.metaNum : perc >= ind.metaNum; return `<tr class="border-b border-slate-100 text-sm"><td class="py-4 font-bold text-slate-700">${ind.nombre}</td><td class="py-4 text-center font-medium">${ind.metaNum}${ind.unidad}</td><td class="py-4 text-center font-black ${success ? 'text-green-600' : 'text-rose-500'}">${perc}%</td><td class="py-4 text-right text-[10px] font-black uppercase tracking-widest">${success ? 'CUMPLIDO' : 'PENDIENTE'}</td></tr>`; }).join('');
                content.innerHTML += `<div class="mb-16" style="page-break-inside: avoid;"><div class="flex justify-between items-end mb-4 border-b-2 border-slate-100 pb-3"><h2 class="text-2xl font-black text-slate-800 uppercase tracking-tighter">${b.name}</h2><span class="text-xl font-black text-rose-500">${progress}% Éxito</span></div><table class="w-full text-left"><thead><tr class="text-[10px] text-slate-400 font-black uppercase tracking-widest"><th class="py-3 px-1">Indicador</th><th class="py-3 px-1 text-center">Meta</th><th class="py-3 px-1 text-center">Logro</th><th class="py-3 px-1 text-right">Situación</th></tr></thead><tbody>${tableRows}</tbody></table></div>`;
            });
            const element = document.getElementById('pdf-template');
            const opt = { margin: 0.5, filename: `Reporte_Evolucion.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } };
            document.getElementById('pdf-report-container').classList.remove('hidden');
            html2pdf().from(element).set(opt).save().then(() => { document.getElementById('pdf-report-container').classList.add('hidden'); });
        };

        window.showModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.hideModal = (id) => document.getElementById(id).classList.add('hidden');
        window.addProgress = (id) => {
            const input = document.getElementById(`inp-${id}`); const val = Number(input.value);
            if (!input.value) return;
            const ind = state.indicators.find(i => i.id === id); ind.valorActual = val;
            ind.historial.push({ valor: val, fecha: new Date().toLocaleDateString() });
            input.value = ''; renderAll();
        };
        window.updateDenominator = (id, val) => { const ind = state.indicators.find(i => i.id === id); ind.totalPeriodo = Number(val); renderAll(); };
        
        document.getElementById('form-kpi').onsubmit = (e) => {
            e.preventDefault();
            const newKpi = { id: 'kpi-'+Date.now(), nombre: document.getElementById('kpi-nombre').value, definicion: document.getElementById('kpi-definicion').value, metaNum: Number(document.getElementById('kpi-meta').value), totalPeriodo: Number(document.getElementById('kpi-total').value), bloque: document.getElementById('kpi-bloque').value, inverso: document.getElementById('kpi-inverso').checked, valorActual: 0, historial: [], unidad: '%' };
            state.indicators.push(newKpi); hideModal('modal-kpi'); renderAll(); e.target.reset();
        };
        document.getElementById('form-block').onsubmit = (e) => {
            e.preventDefault();
            state.blocks.push({ id: 'b-'+Date.now(), name: document.getElementById('block-name').value });
            hideModal('modal-block'); renderBlocks(); e.target.reset();
        };

        window.onload = init;
    </script>
</body>
</html>